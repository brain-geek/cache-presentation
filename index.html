<!DOCTYPE HTML>
<html lang="ru-RU">
<head>
	<title>Ruby on Rails cache workflow</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=1274, user-scalable=no">
	<link rel="stylesheet" href="themes/ribbon/styles/style.css">

  <style>
    #expire_timeout2  pre {
      margin-top: 45px;
    }
    #expire_timeout2  pre code {
      font-size: 50%;
    }

    #rails-default-fixed .error {
      color: red;
      font: bold;
    }

    #rails-default0 header, #rails-default1 header, #rails-default2 header {
      margin: 0px;
    }

    #rails-default-lb pre {
      margin-top:40px;
    }
  </style>
</head>
<body class="list">
	<header class="caption">
		<h1>Ruby on Rails cache workflow</h1>
	</header>
	<div class="slide" id="cover"><div>
		<section>
		  <header>
	        <h1>Ruby on Rails cache workflow</h1>
	      </header>

				<div style="text-align : right;">
				Alexander Rozumii<br />
				github.com/brain-geek<br />
				@brain-geek
				</div>
		</section>
	</div></div>

	<div class="slide shout" id="standard_workflow"><div>
		<section>
			<header>
				<h2>What is standard way of caching in Rails?</h2>
			</header>
		</section>
	</div></div>

  <div class="slide" id="rails-default0"><div>
    <section>
      <header>
        <h2>Fragment caching</h2>
      </header>

      <pre>
        <code>&lt;% cache do %&gt;</code>
        <code>  All available products:</code>
        <code>  &lt;% Product.all.each do |p| %&gt;</code>
        <code>    &lt;%= link_to p.name, product_url(p) %&gt;</code>
        <code>  &lt;% end %&gt;</code>
        <code>&lt;% end %&gt;</code>
      </pre>
    </section>
  </div></div>

  <div class="slide" id="rails-default1"><div>
    <section>
      <header>
        <h2>Action caching</h2>
      </header>

      <pre>
        <code>class ProductsController &lt; ActionController</code>
        <code>  caches_page :index</code>
        <code>  def index</code>
        <code>    @products = Products.all</code>
        <code>  end</code>
        <code>  def create</code>
        <code>    expire_page :action => :index</code>
        <code>  end</code>
        <code>end</code>
      </pre>
    </section>
  </div></div>

  <div class="slide" id="rails-default2"><div>
    <section>
      <header>
        <h2>Expire by sweepers...</h2>
      </header>

      <pre>
        <code>class ProductSweeper &lt; ActionController::Caching::Sweeper</code>
        <code>  observe Product</code>
        <code>  def after_...</code>
        <code>  def expire_cache_for(product)</code>
        <code>    # Expire the index page now that we added a new product</code>
        <code>    expire_page(:controller => 'products', :action => 'index')</code>
        <code>    # Expire a fragment</code>
        <code>    expire_fragment('all_available_products')</code>
        <code>  end</code>
        <code>end</code>      
      </pre>
    </section>
  </div></div>

  <div class="slide" id="expire_timeout0"><div>
    <section>
      <header>
        <h2>...or expire by timeout/cache key</h2>
      </header>

      <code>cache.write(key, value, :expires_in => 1.minute)</code>
      <br />
      <code>cache.write([key, @article], value)</code>
    </section>
  </div></div>

  <div class="slide shout" id="expire_timeout1"><div>
    <section>
      <header>
        <h2>Race condition TTL</h2>
        <!--
        <p>
          Setting :race_condition_ttl is very useful in situations where a cache entry is used very frequently and is under heavy load. If a cache expires and due to heavy load seven different processes will try to read data natively and then they all will try to write to cache. To avoid that case the first process to find an expired cache entry will bump the cache expiration time by the value set in :race_condition_ttl.          
        </p>
        -->
      </header>
    </section>
  </div></div>


  <div class="slide" id="expire_timeout2"><div>
    <section>
      <header>
        <pre>
          <code>cache = ActiveSupport::Cache::MemoryStore.new(:expires_in => 1.minute)</code>
          <code>cache.write("foo", "original value")</code>
          <code>sleep 60</code>
          <code>Thread.new do</code>
          <code>  val_1 = cache.fetch("foo", :race_condition_ttl => 10) do</code>
          <code>    sleep 1</code>
          <code>    "new value 1"</code>
          <code>  end</code>
          <code>end</code>
          <code>Thread.new do</code>
          <code>  val_2 = cache.fetch("foo", :race_condition_ttl => 10) do</code>
          <code>    "new value 2"</code>
          <code>  end</code>
          <code>end</code>
          <code># val_1 => "new value 1"</code>
          <code># val_2 => "original value"</code>
          <code># sleep 10 # First thread extend the life of cache by another 10 seconds</code>
          <code># cache.fetch("foo") => "new value 1"</code>
        </pre>
      </header>
    </section>
  </div></div>

  <div class="slide shout" id="rails-default3"><div>
    <section>
      <header>
        <h2>Let's use it on the real site</h2>
      </header>
    </section>
  </div></div>

  <div class="slide cover" id="lb_nocomments"><div>
    <section>
      <img src="pictures/lb.png" alt="">
    </section>
  </div></div>

  <div class="slide cover" id="lb_commented"><div>
    <section>
      <img src="pictures/lb_commented.png" alt="">
    </section>
  </div></div>

  <div class="slide" id="rails-default-lb"><div>
    <section>
      <pre>
        <code>class NewsSweeper &lt; ActionController::Caching::Sweeper</code>
        <code>  def expire_cache_for(product)</code>
        <code>    expire_fragment('main_slide')</code>
        <code>    expire_fragment('main_theme')</code>
        <!-- <code>    expire_fragment('main_published')</code> -->
        <code>    expire_fragment('main_blogs')</code>
        <code>    expire_fragment('main_top')</code>
        <code>  end</code>
        <code>end</code>      
      </pre>
    </section>
  </div></div>

  <div class="slide" id="rails-default-why-bad"><div>
    <section>
      <header>
        <h2> Why bad? </h2>
      </header>

      <p>
        <b>It is hard to maintain:</b> I've made some mistakes in previous slide
      </p>
    </section>
  </div></div>

  <div class="slide" id="rails-default-fixed"><div>
    <section>
      <pre>
        <code>class NewsSweeper < ActionController::Caching::Sweeper</code>
        <code>  def expire_cache_for(product)</code>
        <code>    expire_fragment('main_slide<span class="error">r</span>')</code>
        <code>    expire_fragment('main_theme')</code>
        <code class="error">    expire_fragment('main_published')</code>
        <code>    expire_fragment('main_blogs')</code>
        <code>    expire_fragment('main_top')</code>
        <code>  end</code>
        <code>end</code>      
      </pre>
    </section>
  </div></div>

  <div class="slide shout" id="what-tools"><div>
    <section>
      <header>
        <h2>What additional tools do we have?</h2>
      </header>
    </section>
  </div></div>

<!--   <div class="slide shout" id="cache_digests0"><div>
    <section>
      <header>
        <h2>Cache Digests</h2>
      </header>
    </section>
  </div></div>

  <div class="slide" id="cache_digests1"><div>
    <section>
      <header>
        <h2>Cache Digests</h2>
      </header>
      <p>
          With this plugin, all calls to #cache in the view will automatically append a digest of that template and all of its dependencies! So you no longer need to manually increment versions in the specific templates you're working on or care about what other templates are depending on the change you make.
      </p>
    </section>
  </div></div> -->

  <div class="slide" id="cachier0"><div>
    <section>
      <header>
        <h2>Cachier</h2>
      </header>
      <p>
        <b>github.com/twinturbo/cashier</b><br />
        Cache associate individual cache keys with a tag, then expire them all at once. This took my 7 layer loop down to one line of code. It's also made managing the cache throught my application much easier.
      </p>
    </section>
  </div></div>


  <div class="slide" id="cachier1"><div>
    <section>
      <header>
        <h2>Cachier</h2>
      </header>

      <pre>
        <code># can have multiple tags</code>
        <code>cache @something, :tag => ['dashboard', 'settings']</code>
        <code># You can also use Rails.cache.write</code>
        <code>Rails.cache.write("foo", "bar", :tag => ["some_tag"])</code>
      </pre>
    </section>
  </div></div>

  <div class="slide" id="cachier2"><div>
    <section>
      <header>
        <h2>Cachier</h2>
      </header>

      <p class="note">
        But you still need to expire keys:
      </p>

      <pre>
        <code># in an observer</code>
        <code>Cashier.expire 'some-component'</code>
      </pre>
    </section>
  </div></div>


  <div class="slide" id="taggable0"><div>
    <section>
      <header>
        <h2>Taggable cache</h2>
      </header>
      <p>
        <b>github.com/brain-geek/taggable-cache</b><br />
        Taggable cache provides possibility for automatic cache entries expiration by providing possibility to map cache keys with AR objects.
      </p>
    </section>
  </div></div>

	<div class="slide" id="taggable1"><div>
		<section>
			<header>
				<h2>Taggable cache</h2>
			</header>

			<pre>				
				<code><% cache 'main_slide', :depends_on => [News.slide] do %></code>
        <code><% cache 'main_theme', :depends_on => [News.theme] do %></code>
        <code><% cache 'main_feed', :depends_on => [News] do %></code>
        <code>&lt;% cache [article, 'related'], </code>
        <code>:depends_on => [@article, article.related] do %></code>
			</pre>
		</section>
	</div></div>

  <div class="slide" id="taggable2"><div>
    <section>
      <header>
        <h2>Taggable cache</h2>
      </header>

      <pre>       
        <code>  caches_action :index</code>
        <code>  def index</code>
        <code>    @page = Page.find(params[:id])</code>
        <code>    @page.load_lot_of_data</code>
        <code>    depends_on @page</code>
        <code>  end</code>
      </pre>
    </section>
  </div></div>

  <div class="slide" id="thank_you"><div>
    <section>
      <header>
          <h1>Thank you!<br />
          Questions?</h1>
        </header>

        <div style="text-align : right;">
        Presentation:<br />
        brain-geek.github.com/cache-presentation<br />
        or<br />
        bit.ly/QKt5sU
        </div>
    </section>
  </div></div>


	<div class="progress"><div></div></div>
	<script src="scripts/script.js"></script>
	<!-- Copyright © 2010–2012 Vadim Makeev — pepelsbey.net -->
</body>
</html>